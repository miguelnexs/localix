<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Frontend Detallado</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .log { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        .debug { border-left-color: #6f42c1; background: #e2d9f3; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; }
        .code-block { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Frontend Detallado</h1>
        <p>Esta p√°gina simula exactamente la l√≥gica del frontend para identificar el problema.</p>
        
        <div class="test-section">
            <h3>Configuraci√≥n</h3>
            <p><strong>API Base URL:</strong> <span id="apiBaseUrl">http://localhost:8000</span></p>
            <p><strong>Endpoint:</strong> <span id="endpoint">/api/usuarios/usage/status/</span></p>
        </div>

        <div class="test-section">
            <h3>Pruebas</h3>
            <button onclick="testCompleteFlow()">üöÄ Prueba Completa (Simula Frontend)</button>
            <button onclick="testProtectedRouteLogic()">üõ°Ô∏è Probar L√≥gica de ProtectedRoute</button>
            <button onclick="testPlanStatusLogic()">üìä Probar L√≥gica de usePlanStatus</button>
            <button onclick="clearLogs()">Limpiar Logs</button>
        </div>

        <div class="test-section">
            <h3>Logs Detallados</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        const API_URL = (path) => `${API_BASE_URL}/api/${path.replace(/^\/+/,'')}`;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Simular el estado del hook usePlanStatus
        let planStatus = {
            isLoading: true,
            isActive: true,
            isExpired: false,
            planData: null,
            error: null
        };

        // Simular la funci√≥n fetchPlanStatus del frontend
        async function fetchPlanStatus(token, user) {
            log('üîç Simulando fetchPlanStatus del frontend...', 'debug');
            
            // Si el usuario es admin (superusuario), no aplicar restricciones de plan
            if (user && user.is_superuser) {
                log('üîß Usuario superusuario detectado, acceso sin restricciones', 'success');
                planStatus = {
                    isLoading: false,
                    isActive: true,
                    isExpired: false,
                    planData: {
                        plan_type: 'premium',
                        days_remaining: 3650,
                        is_active: true,
                        is_expired: false,
                        end_date: new Date(Date.now() + 3650 * 24 * 60 * 60 * 1000).toISOString(),
                        usage_percentage: 0
                    },
                    error: null
                };
                return planStatus;
            }

            try {
                planStatus = { ...planStatus, isLoading: true, error: null };

                log('üîç Verificando estado del plan...', 'debug');
                log(`Token: ${token ? 'Presente' : 'Ausente'}`, 'debug');
                log(`Usuario: ${user?.username}`, 'debug');

                const response = await fetch(API_URL('usuarios/usage/status/'), {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                log(`üì° Respuesta del servidor: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const planData = await response.json();
                    log('üìä Datos del plan recibidos:', 'success');
                    log(`   - Plan type: ${planData.plan_type}`, 'info');
                    log(`   - Days remaining: ${planData.days_remaining}`, 'info');
                    log(`   - Is expired: ${planData.is_expired}`, 'info');
                    log(`   - Is active: ${planData.is_active}`, 'info');
                    log(`   - End date: ${planData.end_date}`, 'info');
                    
                    // L√ìGICA EXACTA DEL FRONTEND
                    const isExpired = planData.is_expired === true;
                    const isActive = !isExpired; // Solo bloquear si est√° realmente expirado
                    
                    log('üîç An√°lisis del frontend (l√≥gica exacta):', 'debug');
                    log(`   - is_expired (API): ${planData.is_expired}`, 'debug');
                    log(`   - isExpired (calculado): ${isExpired}`, 'debug');
                    log(`   - isActive (calculado): ${isActive}`, 'debug');
                    log(`   - days_remaining: ${planData.days_remaining}`, 'debug');
                    
                    planStatus = {
                        isLoading: false,
                        isActive: isActive,
                        isExpired: isExpired,
                        planData: planData,
                        error: null
                    };
                    
                    log('‚úÖ Estado del plan actualizado:', 'success');
                    log(`   - isLoading: ${planStatus.isLoading}`, 'info');
                    log(`   - isActive: ${planStatus.isActive}`, 'info');
                    log(`   - isExpired: ${planStatus.isExpired}`, 'info');
                    
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Error en la respuesta: ${errorText}`, 'error');
                    
                    // Si no se puede verificar el plan, asumir que est√° activo para no bloquear al usuario
                    planStatus = {
                        isLoading: false,
                        isActive: true,
                        isExpired: false,
                        planData: null,
                        error: `Error HTTP: ${response.status}`
                    };
                }
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                
                // En caso de error, asumir que est√° activo para no bloquear al usuario
                planStatus = {
                    isLoading: false,
                    isActive: true,
                    isExpired: false,
                    planData: null,
                    error: error.message
                };
            }
            
            return planStatus;
        }

        // Simular la l√≥gica del ProtectedRoute
        function simulateProtectedRoute(isAuthenticated, authLoading, user, planStatus) {
            log('üõ°Ô∏è Simulando l√≥gica del ProtectedRoute...', 'debug');
            log(`   - isAuthenticated: ${isAuthenticated}`, 'debug');
            log(`   - authLoading: ${authLoading}`, 'debug');
            log(`   - user: ${user?.username}`, 'debug');
            log(`   - planStatus.isLoading: ${planStatus.isLoading}`, 'debug');
            log(`   - planStatus.isActive: ${planStatus.isActive}`, 'debug');
            log(`   - planStatus.isExpired: ${planStatus.isExpired}`, 'debug');

            // Mostrar loading mientras se verifica la autenticaci√≥n y el plan
            if (authLoading || planStatus.isLoading) {
                log('üîÑ ProtectedRoute - Mostrando loading...', 'info');
                return 'LOADING';
            }

            // Si no est√° autenticado, redirigir al login
            if (!isAuthenticated) {
                log('‚ùå ProtectedRoute - Usuario no autenticado, redirigiendo al login', 'error');
                return 'REDIRECT_TO_LOGIN';
            }

            // Mostrar p√°gina de plan expirado si el plan no est√° activo
            if (!planStatus.isActive || planStatus.isExpired) {
                log('‚ùå ProtectedRoute - Plan inactivo o expirado, mostrando PlanExpired', 'error');
                log(`   - isActive: ${planStatus.isActive}`, 'error');
                log(`   - isExpired: ${planStatus.isExpired}`, 'error');
                log(`   - planData: ${JSON.stringify(planStatus.planData)}`, 'error');
                return 'SHOW_PLAN_EXPIRED';
            }

            // Si todo est√° bien, mostrar el contenido
            log('‚úÖ ProtectedRoute - Acceso permitido, mostrando contenido', 'success');
            return 'SHOW_CONTENT';
        }

        async function testCompleteFlow() {
            log('üöÄ Iniciando prueba completa del frontend...', 'info');
            
            // 1. Login
            log('\n1. üîê Realizando login...', 'info');
            const loginData = {
                username: 'test_trial',
                password: 'testpass123'
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/usuarios/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Login exitoso', 'success');
                    log(`üë§ Usuario: ${result.user.username}`, 'info');
                    log(`üîß Es superusuario: ${result.user.is_superuser}`, 'info');
                    
                    const token = result.tokens.access;
                    const user = result.user;
                    
                    // 2. Obtener estado del plan
                    log('\n2. üìä Obteniendo estado del plan...', 'info');
                    const planStatusResult = await fetchPlanStatus(token, user);
                    
                    // 3. Simular ProtectedRoute
                    log('\n3. üõ°Ô∏è Simulando ProtectedRoute...', 'info');
                    const protectedRouteResult = simulateProtectedRoute(
                        true, // isAuthenticated
                        false, // authLoading
                        user,
                        planStatusResult
                    );
                    
                    log(`\nüéØ RESULTADO FINAL: ${protectedRouteResult}`, 'success');
                    
                    if (protectedRouteResult === 'SHOW_PLAN_EXPIRED') {
                        log('‚ùå PROBLEMA DETECTADO: Se est√° mostrando PlanExpired cuando no deber√≠a', 'error');
                        log('üîç Esto significa que isActive es false o isExpired es true incorrectamente', 'error');
                    } else if (protectedRouteResult === 'SHOW_CONTENT') {
                        log('‚úÖ CORRECTO: Se deber√≠a mostrar el contenido del dashboard', 'success');
                    }
                    
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Error en login: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testProtectedRouteLogic() {
            log('üõ°Ô∏è Probando diferentes escenarios del ProtectedRoute...', 'info');
            
            // Escenario 1: Usuario autenticado, plan activo
            log('\nüìã Escenario 1: Usuario autenticado, plan activo', 'info');
            const result1 = simulateProtectedRoute(
                true, // isAuthenticated
                false, // authLoading
                { username: 'test_user', is_superuser: false },
                { isLoading: false, isActive: true, isExpired: false, planData: { plan_type: 'trial', days_remaining: 14 } }
            );
            log(`Resultado: ${result1}`, result1 === 'SHOW_CONTENT' ? 'success' : 'error');
            
            // Escenario 2: Usuario autenticado, plan expirado
            log('\nüìã Escenario 2: Usuario autenticado, plan expirado', 'info');
            const result2 = simulateProtectedRoute(
                true, // isAuthenticated
                false, // authLoading
                { username: 'test_user', is_superuser: false },
                { isLoading: false, isActive: false, isExpired: true, planData: { plan_type: 'trial', days_remaining: 0 } }
            );
            log(`Resultado: ${result2}`, result2 === 'SHOW_PLAN_EXPIRED' ? 'success' : 'error');
            
            // Escenario 3: Usuario no autenticado
            log('\nüìã Escenario 3: Usuario no autenticado', 'info');
            const result3 = simulateProtectedRoute(
                false, // isAuthenticated
                false, // authLoading
                null,
                { isLoading: false, isActive: true, isExpired: false, planData: null }
            );
            log(`Resultado: ${result3}`, result3 === 'REDIRECT_TO_LOGIN' ? 'success' : 'error');
        }

        async function testPlanStatusLogic() {
            log('üìä Probando l√≥gica de usePlanStatus...', 'info');
            
            // Simular diferentes respuestas de la API
            const testCases = [
                {
                    name: 'Plan activo (trial)',
                    apiResponse: {
                        plan_type: 'trial',
                        days_remaining: 14,
                        is_expired: false,
                        is_active: true,
                        end_date: '2025-09-03T06:08:53.222322+00:00'
                    }
                },
                {
                    name: 'Plan expirado',
                    apiResponse: {
                        plan_type: 'trial',
                        days_remaining: 0,
                        is_expired: true,
                        is_active: false,
                        end_date: '2025-08-01T00:00:00+00:00'
                    }
                },
                {
                    name: 'Plan inactivo',
                    apiResponse: {
                        plan_type: 'basic',
                        days_remaining: 5,
                        is_expired: false,
                        is_active: false,
                        end_date: '2025-09-10T00:00:00+00:00'
                    }
                }
            ];
            
            for (const testCase of testCases) {
                log(`\nüß™ Probando: ${testCase.name}`, 'info');
                log(`API Response: ${JSON.stringify(testCase.apiResponse)}`, 'debug');
                
                const isExpired = testCase.apiResponse.is_expired === true;
                const isActive = !isExpired;
                
                log(`Resultado calculado:`, 'info');
                log(`   - isExpired: ${isExpired}`, 'info');
                log(`   - isActive: ${isActive}`, 'info');
                
                if (isActive && !isExpired) {
                    log('   ‚úÖ Usuario deber√≠a tener acceso', 'success');
                } else {
                    log('   ‚ùå Usuario NO deber√≠a tener acceso', 'error');
                }
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Mostrar configuraci√≥n al cargar
        window.onload = function() {
            log('üìã Configuraci√≥n cargada:', 'info');
            log(`   - API Base URL: ${API_BASE_URL}`, 'info');
            log(`   - Endpoint: ${API_URL('usuarios/usage/status/')}`, 'info');
        };
    </script>
</body>
</html>
