<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Dashboard - Localix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
        .info {
            background: #2196F3;
        }
        .info:hover {
            background: #0b7dda;
        }
        .warning {
            background: #ff9800;
        }
        .warning:hover {
            background: #e68900;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
        }
        .success {
            background: rgba(76, 175, 80, 0.3);
        }
        .error {
            background: rgba(244, 67, 54, 0.3);
        }
        .warning-bg {
            background: rgba(255, 193, 7, 0.3);
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
        }
        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #4CAF50;
            background: rgba(255, 255, 255, 0.1);
        }
        .step.error {
            border-left-color: #f44336;
        }
        .step.warning {
            border-left-color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Dashboard - Localix</h1>
        <p>Esta p√°gina nos ayudar√° a identificar por qu√© no se cargan los productos y datos en el dashboard.</p>
        
        <div id="status"></div>
        <div id="log" class="log"></div>
        
        <div class="test-section">
            <h3>üîê Paso 1: Verificar Autenticaci√≥n</h3>
            <button onclick="checkAuthentication()" class="info">Verificar Auth</button>
            <button onclick="simulateLogin()" class="warning">Simular Login</button>
            <button onclick="clearAuth()" class="danger">Limpiar Auth</button>
            <div id="authStatus"></div>
        </div>
        
        <div class="test-section">
            <h3>üåê Paso 2: Verificar Backend</h3>
            <button onclick="testBackendConnection()" class="info">Test Conexi√≥n Backend</button>
            <button onclick="testCategoriesAPI()" class="info">Test Categor√≠as API</button>
            <button onclick="testProductsAPI()" class="info">Test Productos API</button>
            <button onclick="testDashboardAPI()" class="info">Test Dashboard API</button>
            <div id="backendStatus"></div>
        </div>
        
        <div class="test-section">
            <h3>‚ö° Paso 3: Verificar Electron API</h3>
            <button onclick="testElectronAPI()" class="info">Test Electron API</button>
            <button onclick="testCategoriesIPC()" class="info">Test Categor√≠as IPC</button>
            <button onclick="testProductsIPC()" class="info">Test Productos IPC</button>
            <button onclick="testDashboardIPC()" class="info">Test Dashboard IPC</button>
            <div id="electronStatus"></div>
        </div>
        
        <div class="test-section">
            <h3>üöÄ Paso 4: Verificar Preload Context</h3>
            <button onclick="testPreloadContext()" class="info">Test Preload Context</button>
            <button onclick="testPreloadFunctions()" class="info">Test Funciones Preload</button>
            <div id="preloadStatus"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Paso 5: Diagn√≥stico Completo</h3>
            <button onclick="runFullDiagnosis()" class="warning">Ejecutar Diagn√≥stico Completo</button>
            <button onclick="clearLog()" class="danger">Limpiar Log</button>
            <div id="diagnosisStatus"></div>
        </div>
    </div>

    <script>
        let logMessages = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logMessages.push(logEntry);
            
            const logElement = document.getElementById('log');
            logElement.innerHTML = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLog() {
            logMessages = [];
            document.getElementById('log').innerHTML = '';
        }
        
        function showStatus(message, type = 'info', elementId = 'status') {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            log(message, type);
        }
        
        function showResult(data, elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        function addStep(message, type = 'success') {
            const diagnosisDiv = document.getElementById('diagnosisStatus');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${type}`;
            stepDiv.innerHTML = message;
            diagnosisDiv.appendChild(stepDiv);
            log(message, type);
        }
        
        // Paso 1: Verificar Autenticaci√≥n
        async function checkAuthentication() {
            try {
                const token = localStorage.getItem('access_token');
                const refreshToken = localStorage.getItem('refresh_token');
                const user = localStorage.getItem('user');
                
                const authInfo = {
                    hasAccessToken: !!token,
                    hasRefreshToken: !!refreshToken,
                    hasUser: !!user,
                    tokenLength: token ? token.length : 0,
                    refreshTokenLength: refreshToken ? refreshToken.length : 0,
                    userData: user ? JSON.parse(user) : null
                };
                
                if (authInfo.hasAccessToken) {
                    showStatus('‚úÖ Usuario autenticado', 'success', 'authStatus');
                    addStep('‚úÖ Usuario autenticado correctamente');
                } else {
                    showStatus('‚ùå Usuario no autenticado', 'error', 'authStatus');
                    addStep('‚ùå Usuario no autenticado - Este es el problema principal', 'error');
                }
                
                showResult(authInfo, 'authStatus');
                
            } catch (error) {
                showStatus(`‚ùå Error verificando auth: ${error.message}`, 'error', 'authStatus');
                addStep(`‚ùå Error verificando auth: ${error.message}`, 'error');
            }
        }
        
        async function simulateLogin() {
            try {
                // Simular login con datos reales
                const loginData = {
                    username: 'admin',
                    password: 'admin123'
                };
                
                const response = await fetch('http://localhost:8000/api/usuarios/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    localStorage.setItem('access_token', data.tokens.access);
                    localStorage.setItem('refresh_token', data.tokens.refresh);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    showStatus('‚úÖ Login simulado exitosamente', 'success', 'authStatus');
                    addStep('‚úÖ Login simulado exitosamente');
                    
                    // Verificar auth nuevamente
                    await checkAuthentication();
                } else {
                    showStatus(`‚ùå Error en login: ${data.message || 'Error desconocido'}`, 'error', 'authStatus');
                    addStep(`‚ùå Error en login: ${data.message || 'Error desconocido'}`, 'error');
                }
                
            } catch (error) {
                showStatus(`‚ùå Error simulando login: ${error.message}`, 'error', 'authStatus');
                addStep(`‚ùå Error simulando login: ${error.message}`, 'error');
            }
        }
        
        function clearAuth() {
            try {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                showStatus('‚úÖ Autenticaci√≥n limpiada', 'success', 'authStatus');
                addStep('‚úÖ Autenticaci√≥n limpiada');
            } catch (error) {
                showStatus(`‚ùå Error limpiando auth: ${error.message}`, 'error', 'authStatus');
            }
        }
        
        // Paso 2: Verificar Backend
        async function testBackendConnection() {
            try {
                const response = await fetch('http://localhost:8000/api/categorias/test_connection/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('‚úÖ Backend conectado correctamente', 'success', 'backendStatus');
                    addStep('‚úÖ Backend conectado correctamente');
                } else {
                    showStatus(`‚ùå Error backend: ${response.status}`, 'error', 'backendStatus');
                    addStep(`‚ùå Error backend: ${response.status}`, 'error');
                }
                
                showResult(data, 'backendStatus');
                
            } catch (error) {
                showStatus(`‚ùå Error conectando backend: ${error.message}`, 'error', 'backendStatus');
                addStep(`‚ùå Error conectando backend: ${error.message}`, 'error');
            }
        }
        
        async function testCategoriesAPI() {
            try {
                const token = localStorage.getItem('access_token');
                const headers = {
                    'Accept': 'application/json'
                };
                
                if (token) {
                    headers.Authorization = `Bearer ${token}`;
                }
                
                const response = await fetch('http://localhost:8000/api/categorias/', {
                    method: 'GET',
                    headers: headers
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('‚úÖ Categor√≠as API funcionando', 'success', 'backendStatus');
                    addStep(`‚úÖ Categor√≠as API funcionando - ${data.results ? data.results.length : data.length} categor√≠as`);
                } else {
                    showStatus(`‚ùå Error Categor√≠as API: ${response.status}`, 'error', 'backendStatus');
                    addStep(`‚ùå Error Categor√≠as API: ${response.status} - ${data.detail || data.message}`, 'error');
                }
                
                showResult({
                    status: response.status,
                    count: data.results ? data.results.length : data.length,
                    data: data.results || data
                }, 'backendStatus');
                
            } catch (error) {
                showStatus(`‚ùå Error Categor√≠as API: ${error.message}`, 'error', 'backendStatus');
                addStep(`‚ùå Error Categor√≠as API: ${error.message}`, 'error');
            }
        }
        
        async function testProductsAPI() {
            try {
                const token = localStorage.getItem('access_token');
                const headers = {
                    'Accept': 'application/json'
                };
                
                if (token) {
                    headers.Authorization = `Bearer ${token}`;
                }
                
                const response = await fetch('http://localhost:8000/api/productos/', {
                    method: 'GET',
                    headers: headers
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('‚úÖ Productos API funcionando', 'success', 'backendStatus');
                    addStep(`‚úÖ Productos API funcionando - ${data.results ? data.results.length : data.length} productos`);
                } else {
                    showStatus(`‚ùå Error Productos API: ${response.status}`, 'error', 'backendStatus');
                    addStep(`‚ùå Error Productos API: ${response.status} - ${data.detail || data.message}`, 'error');
                }
                
                showResult({
                    status: response.status,
                    count: data.results ? data.results.length : data.length,
                    data: data.results || data
                }, 'backendStatus');
                
            } catch (error) {
                showStatus(`‚ùå Error Productos API: ${error.message}`, 'error', 'backendStatus');
                addStep(`‚ùå Error Productos API: ${error.message}`, 'error');
            }
        }
        
        async function testDashboardAPI() {
            try {
                const token = localStorage.getItem('access_token');
                const headers = {
                    'Accept': 'application/json'
                };
                
                if (token) {
                    headers.Authorization = `Bearer ${token}`;
                }
                
                const response = await fetch('http://localhost:8000/api/ventas/resumen/', {
                    method: 'GET',
                    headers: headers
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('‚úÖ Dashboard API funcionando', 'success', 'backendStatus');
                    addStep('‚úÖ Dashboard API funcionando');
                } else {
                    showStatus(`‚ùå Error Dashboard API: ${response.status}`, 'error', 'backendStatus');
                    addStep(`‚ùå Error Dashboard API: ${response.status} - ${data.detail || data.message}`, 'error');
                }
                
                showResult(data, 'backendStatus');
                
            } catch (error) {
                showStatus(`‚ùå Error Dashboard API: ${error.message}`, 'error', 'backendStatus');
                addStep(`‚ùå Error Dashboard API: ${error.message}`, 'error');
            }
        }
        
        // Paso 3: Verificar Electron API
        function testElectronAPI() {
            try {
                if (window.electronAPI) {
                    showStatus('‚úÖ Electron API disponible', 'success', 'electronStatus');
                    addStep('‚úÖ Electron API disponible');
                    
                    const apis = Object.keys(window.electronAPI);
                    showResult({
                        available: true,
                        apis: apis,
                        hasCategorias: !!window.electronAPI.categorias,
                        hasProductos: !!window.electronAPI.productos,
                        hasVentas: !!window.electronAPI.ventas
                    }, 'electronStatus');
                } else {
                    showStatus('‚ùå Electron API no disponible', 'error', 'electronStatus');
                    addStep('‚ùå Electron API no disponible', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error Electron API: ${error.message}`, 'error', 'electronStatus');
                addStep(`‚ùå Error Electron API: ${error.message}`, 'error');
            }
        }
        
        async function testCategoriesIPC() {
            try {
                if (window.electronAPI?.categorias?.listar) {
                    const result = await window.electronAPI.categorias.listar();
                    showStatus('‚úÖ Categor√≠as IPC funcionando', 'success', 'electronStatus');
                    addStep(`‚úÖ Categor√≠as IPC funcionando - ${result.length} categor√≠as`);
                    showResult({
                        count: result.length,
                        data: result
                    }, 'electronStatus');
                } else {
                    showStatus('‚ùå Categor√≠as IPC no disponible', 'error', 'electronStatus');
                    addStep('‚ùå Categor√≠as IPC no disponible', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error Categor√≠as IPC: ${error.message}`, 'error', 'electronStatus');
                addStep(`‚ùå Error Categor√≠as IPC: ${error.message}`, 'error');
            }
        }
        
        async function testProductsIPC() {
            try {
                if (window.electronAPI?.productos?.cargarProductosYCategorias) {
                    const result = await window.electronAPI.productos.cargarProductosYCategorias();
                    showStatus('‚úÖ Productos IPC funcionando', 'success', 'electronStatus');
                    addStep(`‚úÖ Productos IPC funcionando - ${result.products ? result.products.length : 0} productos`);
                    showResult({
                        count: result.products ? result.products.length : 0,
                        data: result
                    }, 'electronStatus');
                } else {
                    showStatus('‚ùå Productos IPC no disponible', 'error', 'electronStatus');
                    addStep('‚ùå Productos IPC no disponible', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error Productos IPC: ${error.message}`, 'error', 'electronStatus');
                addStep(`‚ùå Error Productos IPC: ${error.message}`, 'error');
            }
        }
        
        async function testDashboardIPC() {
            try {
                if (window.electronAPI?.ventas?.obtenerEstadisticas) {
                    const result = await window.electronAPI.ventas.obtenerEstadisticas();
                    showStatus('‚úÖ Dashboard IPC funcionando', 'success', 'electronStatus');
                    addStep('‚úÖ Dashboard IPC funcionando');
                    showResult(result, 'electronStatus');
                } else {
                    showStatus('‚ùå Dashboard IPC no disponible', 'error', 'electronStatus');
                    addStep('‚ùå Dashboard IPC no disponible', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error Dashboard IPC: ${error.message}`, 'error', 'electronStatus');
                addStep(`‚ùå Error Dashboard IPC: ${error.message}`, 'error');
            }
        }
        
        // Paso 4: Verificar Preload Context
        function testPreloadContext() {
            try {
                // Verificar si el contexto de preload est√° disponible
                const preloadInfo = {
                    localStorage: {
                        available: typeof(Storage) !== "undefined",
                        items: localStorage.length
                    },
                    electron: {
                        available: typeof window !== 'undefined' && window.process && window.process.type,
                        processType: window.process?.type || 'unknown'
                    },
                    apis: {
                        electronAPI: !!window.electronAPI,
                        fetch: !!window.fetch
                    }
                };
                
                showStatus('‚úÖ Preload Context disponible', 'success', 'preloadStatus');
                addStep('‚úÖ Preload Context disponible');
                showResult(preloadInfo, 'preloadStatus');
                
            } catch (error) {
                showStatus(`‚ùå Error Preload Context: ${error.message}`, 'error', 'preloadStatus');
                addStep(`‚ùå Error Preload Context: ${error.message}`, 'error');
            }
        }
        
        function testPreloadFunctions() {
            try {
                // Simular las funciones de preload
                const token = localStorage.getItem('access_token');
                const isAuthenticated = !!token;
                
                const preloadInfo = {
                    isAuthenticated: isAuthenticated,
                    token: token ? 'Presente' : 'Ausente',
                    strategy: isAuthenticated ? 'API HTTP Directa' : 'Electron IPC',
                    timestamp: new Date().toISOString()
                };
                
                showStatus('‚úÖ Funciones Preload verificadas', 'success', 'preloadStatus');
                addStep(`‚úÖ Estrategia de preload: ${preloadInfo.strategy}`);
                showResult(preloadInfo, 'preloadStatus');
                
            } catch (error) {
                showStatus(`‚ùå Error Funciones Preload: ${error.message}`, 'error', 'preloadStatus');
                addStep(`‚ùå Error Funciones Preload: ${error.message}`, 'error');
            }
        }
        
        // Paso 5: Diagn√≥stico Completo
        async function runFullDiagnosis() {
            clearLog();
            document.getElementById('diagnosisStatus').innerHTML = '';
            
            addStep('üöÄ Iniciando diagn√≥stico completo...', 'info');
            
            // Paso 1: Verificar autenticaci√≥n
            addStep('üìã Paso 1: Verificando autenticaci√≥n...', 'info');
            await checkAuthentication();
            
            // Paso 2: Verificar backend
            addStep('üìã Paso 2: Verificando backend...', 'info');
            await testBackendConnection();
            await testCategoriesAPI();
            await testProductsAPI();
            await testDashboardAPI();
            
            // Paso 3: Verificar Electron API
            addStep('üìã Paso 3: Verificando Electron API...', 'info');
            testElectronAPI();
            await testCategoriesIPC();
            await testProductsIPC();
            await testDashboardIPC();
            
            // Paso 4: Verificar Preload Context
            addStep('üìã Paso 4: Verificando Preload Context...', 'info');
            testPreloadContext();
            testPreloadFunctions();
            
            // Resumen
            addStep('üìã Diagn√≥stico completo finalizado', 'info');
            
            // Verificar si hay problemas principales
            const token = localStorage.getItem('access_token');
            if (!token) {
                addStep('‚ö†Ô∏è PROBLEMA PRINCIPAL: Usuario no autenticado. Los datos no se cargar√°n.', 'warning');
            }
            
            if (!window.electronAPI) {
                addStep('‚ö†Ô∏è PROBLEMA: Electron API no disponible. El preload no funcionar√°.', 'warning');
            }
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', () => {
            log('üîç P√°gina de diagn√≥stico cargada');
            showStatus('üöÄ P√°gina de diagn√≥stico lista', 'success');
        });
    </script>
</body>
</html>

